---
title: ç›´æ’­å¼¹å¹•äº’åŠ¨æ¸¸æˆ
tags: []
date: 2023-10-25 08:31:27
---

## ç®€ä»‹

å¼¹å¹•äº’åŠ¨æ¸¸æˆ æ˜¯è¿‘å¹´æ¥åœ¨æ¸¸æˆï¼ˆè¯¯ï¼šç›´æ’­ï¼‰è¡Œä¸šä¸­è¶Šæ¥è¶Šå—åˆ°æ¬¢è¿çš„æ¸¸æˆå½¢å¼ã€‚è¿™ç§æ¸¸æˆé€šè¿‡æ”¶é›†ç©å®¶çš„å¼¹å¹•ä¿¡æ¯ï¼Œå°†å…¶å®æ—¶æ˜¾ç¤ºåœ¨æ¸¸æˆç”»é¢ä¸­ï¼Œå¢åŠ äº†äº’åŠ¨æ€§å’Œè¶£å‘³æ€§ï¼Œåœ¨æŠ–éŸ³ã€Bç«™ç­‰ç›´æ’­å¹³å°ï¼Œç›®å‰å·²ç»æœ‰å¾ˆå¤šé«˜äººæ°”çš„å¼¹å¹•äº’åŠ¨ç±»æ¸¸æˆã€‚å…¶ä¸­æ—¢æœ‰ç¬¬ä¸‰æ–¹å¼€å‘çš„ä¹Ÿæœ‰å¹³å°è‡ªèº«ç ”å‘çš„ã€‚

![image](https://user-images.githubusercontent.com/9689442/221814516-5acdd0aa-a5dc-4c98-b619-2bbb502834f5.png)

---

## ç‰¹ç‚¹

å¼¹å¹•äº’åŠ¨æ¸¸æˆæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¼¹å¹•äº’åŠ¨ã€‚ä¼ ç»Ÿçš„æ¸¸æˆæ¨¡å¼å¾€å¾€æ˜¯å•å‘çš„ï¼Œç©å®¶åªæ˜¯è¢«åŠ¨åœ°æ¥å—æ¸¸æˆçš„å†…å®¹ã€‚è€Œå¼¹å¹•äº’åŠ¨æ¸¸æˆåˆ™ä¸åŒï¼Œç©å®¶å¯ä»¥åœ¨æ¸¸æˆä¸­å‘å°„å¼¹å¹•ï¼Œé€šè¿‡ä¸å…¶ä»–ç©å®¶äº’åŠ¨ï¼Œå¢åŠ äº†æ¸¸æˆçš„è¶£å‘³æ€§å’Œäº’åŠ¨æ€§ã€‚æ­¤å¤–ï¼Œå¼¹å¹•äº’åŠ¨æ¸¸æˆè¿˜å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼šå¤šæ ·åŒ–çš„æ¸¸æˆæ¨¡å¼ã€å®æ—¶äº’åŠ¨çš„ä½“éªŒã€å…¨çƒç©å®¶çš„äº’åŠ¨ç­‰ã€‚

---

### æ¸¸æˆæ¨¡å¼å¤šæ ·åŒ–ï¼š

1. ç©å®¶é˜µè¥å¯¹æŠ—ï¼Œç”¨æˆ·é€šè¿‡å¼¹å¹•é€‰æ‹©é˜µè¥ï¼Œç”ŸæˆAIå°å…µåšé˜µè¥å¯¹æŠ—ï¼Œç‚¹èµ or æ¶ˆè´¹ä¸åŒé‡‘é¢çš„ç¤¼ç‰©å¯ä»¥è·å–é¢å¤–çš„ä¼˜åŠ¿ï¼ˆæ°ªé‡‘å¤–æŒ‚ï¼‰ï¼Œå¸®åŠ©å·±æ–¹é˜µè¥è·èƒœã€‚eg.æŠ–éŸ³ã€Šæ£®æ—æ´¾å¯¹ã€‹

![image](https://user-images.githubusercontent.com/9689442/221814630-ae187097-50f8-4a25-8a9a-28a32fbe2a68.png)

2.  ç©å®¶ä¸ä¸»æ’­åŒé˜µè¥ï¼Œå¯¹æŠ—ç¬¬ä¸‰æ–¹ï¼šAIè§’è‰²/éšœç¢ï¼Œ
3. ç©å®¶å¯¹æŠ—ä¸»æ’­ï¼šç©å®¶é€šè¿‡å¼¹å¹•ç”Ÿäº§AIè§’è‰²/éšœç¢æ¥é˜»ç¢ä¸»æ’­è·å¾—èƒœåˆ©ã€‚egã€‚ã€Šæ˜¯å…„å¼Ÿå°±æ¥ç æˆ‘ã€‹

![image](https://user-images.githubusercontent.com/9689442/221814931-ac1da372-d599-4000-b604-169e2a149383.png)

4. ä¸»æ’­é—´çš„å¯¹æŠ—ï¼Œç»“åˆ2ã€3ç©æ³•ï¼Œç©å®¶å¯ä»¥é€‰æ‹©å¸®åŠ©è‡ªå·±æ”¯æŒçš„ç›´æ’­é—´ï¼Œç»™åŒé˜µè¥ä¸»æ’­æä¾›å¸®åŠ©ï¼Œç»™å¯¹æ–¹é˜µè¥ä¸»æ’­ä½¿ç»Šå­ï¼Œä»¥è¾¾åˆ°å·±æ–¹è·èƒœçš„ç›®çš„ã€‚å¦‚æœè¯´1ã€2ã€3æ›´å¤šåƒä¸€ä¸ªå•æœºæ¸¸æˆï¼Œé‚£ä¹ˆ4æ›´åƒä¸€ä¸ªç½‘æ¸¸ã€‚
5. ä¸»æ’­æˆæƒç»™è§‚ä¼—æ“ä½œä¼ ç»Ÿæ¸¸æˆè§’è‰²çš„æƒåˆ©ï¼Œæœ‰ç‚¹å„¿åå‘äºç¤¾ä¼šå­¦å®éªŒçš„æ€§è´¨ï¼Œæ“ä½œéš¾åº¦æé«˜ï¼Œæœ€æ—©æ˜¯åœ¨å›½å¤–æ¸¸æˆç›´æ’­å¹³å°twitchä¸Šå‡ºç°ï¼Œä»£è¡¨æ¡ˆä¾‹ï¼šç´¯è®¡æœ‰è¶…è¿‡ç™¾ä¸‡åè§‚ä¼—é€šè¿‡å¼¹å¹•å‚ä¸é€šå…³ç¥å¥‡å®è´ï¼Œåæ¥å›½å†…ä¸»æ’­ä¹Ÿæœ‰æ•ˆä»¿ä¹‹ä½œï¼Œæ¯”å¦‚Bç«™çš„ä¸‡äººåŸç¥ï¼š

https://www.bilibili.com/video/BV1xQ4y1Q7CU/?vd_source=13a87a9b97c2b7b5b32c8f91714ede90

---

### å®æ—¶åˆä¸â€œå®æ—¶â€

---

ä¼ ç»Ÿæ¸¸æˆç›´æ’­æ¨¡å¼ï¼Œ

ä»¥ç©å®¶ä½œä¸ºä¿¡æ¯çš„æ¥æ”¶æ–¹ä¸ºä¸»ï¼Œéƒ¨åˆ†ä¸»æ’­ä¼šåˆ¶å®šè‡ªå·±çš„ç§äººè§„åˆ™ï¼Œæ¥æå‡ç©å®¶çš„å‚ä¸åº¦ï¼Œæ¯”å¦‚ï¼š

1. ç¤¼ç‰©è´¡çŒ®é«˜çš„ç©å®¶å¯ä»¥ç›´æ¥å‚ä¸æ¸¸æˆï¼ˆå¤šäººç½‘æ¸¸åœºæ™¯

![image](https://user-images.githubusercontent.com/9689442/221815082-04303610-75e7-4444-ad08-6f1f0d393fe5.png)

2. ä¸»æ’­é˜…è¯»å¼¹å¹•äº’åŠ¨ï¼Œâ€œè°¢è°¢xxxé€çš„xxxxâ€ ğŸ”¥

---

äº’åŠ¨å¼¹å¹•æ¸¸æˆæ¨¡å¼

è™½ç„¶å¼¹å¹•äº’åŠ¨æ¸¸æˆå£°ç§°è‡ªå·±æ˜¯å®æ—¶çš„ï¼Œä½†æ˜¯ç›´æ’­å¼¹å¹•äº’åŠ¨å®é™…ä¸Šæ˜¯é«˜å»¶è¿Ÿçš„ä¸€ä¸ªæ“ä½œã€‚å…·ä½“ä½“ç°åœ¨å‡ ä¸ªé˜¶æ®µï¼š

1. ç”¨æˆ·æ”¶åˆ°ä¸»æ’­æ¸¸æˆç”»é¢çš„å»¶è¿Ÿ
2. ä¸»æ’­å»¶è¿Ÿæ”¶åˆ°ç”¨æˆ·å¼¹å¹•
3. å¼¹å¹•ä½œç”¨äºæ¸¸æˆçš„æ•ˆæœå†é€šè¿‡ç›´æ’­æµå»¶è¿Ÿæ’­æ”¾ç»™ç”¨æˆ·

ç”¨æˆ·å®Œæˆä¸€æ¬¡å¼¹å¹•äº¤äº’ï¼Œè‡³å°‘éœ€è¦3æ¬¡é€šä¿¡ï¼Œè€Œä¸”æ˜¯è¿œè¿œæ»åçš„ã€‚


![image](https://www.plantuml.com/plantuml/png/SoWkIImgAStDuKeiBSdFAyrDIYtYUh9ZzxD9QnLqxHIUpUbzshNmwSmL2bOAptRiUDRH_tpAxfTp5t719K2gdazPyQnZExeIY2YAALOAJ_ViVBfpAgfsY7LmEGWNK-9PJ_kJtKkUTIv_iR3d_PwUPxEtF9ks0Tb6AhcRoo4rBmKO8W00)

è¿™å°±é™åˆ¶äº†å¼¹å¹•äº’åŠ¨æ¸¸æˆçš„ç§ç±»ï¼Œé«˜å®æ—¶æ“ä½œæ€§çš„æ¸¸æˆï¼Œåœ¨å¼¹å¹•äº’åŠ¨åœºæ™¯ä¸‹å˜æˆäº†hardæ¨¡å¼ï¼Œè¿™ä¸ªä¸€ä¼šæˆ‘ä»¬å¯ä»¥ä½“éªŒä¸€ä¸‹ã€‚

---












# æˆ‘ä»¬æ¥è¯•ç€æ•´ä¸€ä¸ªç›´æ’­å¼¹å¹•äº’åŠ¨æ¸¸æˆç©ä¸€ä¸‹

å‡ ä¸ªè¦ç´ 

- ç›´æ’­
- å¼¹å¹•
- æ¸¸æˆ
- å¼¹å¹•å’Œæ¸¸æˆçš„è¿æ¥

æˆ‘ä»¬ä»¥Bç«™ä¸ºä¾‹

---

## ç›´æ’­

---

### ä½¿ç”¨bç«™çš„å®˜æ–¹ç›´æ’­è½¯ä»¶ï¼šï¼ˆç›®å‰ä¸å…¼å®¹éM1çš„macï¼‰

[[å“”å“©å“”å“©ç›´æ’­å§¬ä¸‹è½½](https://live.bilibili.com/liveHime?source=activity)](https://live.bilibili.com/liveHime?source=activity)

å®é™…ä¸Šï¼ŒBç«™è‡ªå·±çš„ç›´æ’­ç«¯åœ¨ç›´æ’­æ¸¸æˆè¿™ä¸ªåœºæ™¯ä¸å¤ªå¥½ç”¨ï¼Œäº²æµ‹åŒè®¾å¤‡çš„æƒ…å†µä¸‹ï¼Œä¸ºæ»¡è¶³ç›´æ’­+æ¸¸æˆæ€§èƒ½ï¼Œæ¸…æ™°åº¦å¾ˆä½ç”»è´¨å¾ˆçƒ‚ã€‚

---

### OBS+ç¬¬ä¸‰æ–¹æ’ä»¶ + bç«™ç›´æ’­æœåŠ¡å™¨åœ°å€å’Œæ¨æµç 

åœ¨Bç«™å¼€å¯ç›´æ’­é—´åï¼Œå¯ä»¥åœ¨ä¸ªäººä¸­å¿ƒï¼šæˆ‘çš„ç›´æ’­é—´ï¼Œçœ‹åˆ°æœåŠ¡å™¨åœ°å€å’Œæ¨æµç 

![image](https://user-images.githubusercontent.com/9689442/221815478-7e59758a-36d9-44da-8f1c-9f29fae29821.png)

åœ¨obsçš„ç›´æ’­è®¾ç½®ä¸­å¡«å†™æœåŠ¡å™¨åœ°å€å’Œæ¨æµç 

![Untitled](https://user-images.githubusercontent.com/9689442/221815898-99a49e28-893d-4b62-af06-98d581aba5bd.png)

OBS æä¾›äº†æ•æ‰

- çª—å£
- ç½‘é¡µ
- å±å¹•
- â€¦

ç­‰èƒ½åŠ›ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡å–çš„æ–¹æ¡ˆå¯ä»¥æœ‰

 

- è‡ªå·±å¼€å‘ä¸€ä¸ªç½‘é¡µï¼Œåœ¨ç½‘é¡µä¸­è®¢é˜…å¼¹å¹•+æ§åˆ¶æ¸¸æˆï¼ŒOBSæ•æ‰è¯¥ç½‘é¡µ
- è‡ªå·±å¼€å‘ä¸€ä¸ªå¼¹å¹•è®¢é˜…+ æ‰§è¡Œnativeæ–¹æ³•çš„è½¯ä»¶ï¼Œ nativeæ¸¸æˆã€å®¢æˆ·ç«¯åŒå­¦å¯ä»¥å°è¯•ä¸€ä¸‹

ä¸‹é¢åˆ†åˆ«è¯´ä¸€ä¸‹å¼¹å¹•å’Œæ¸¸æˆçš„part

## å¼¹å¹•

---

bç«™å¼€æ”¾äº†ä¸»æ’­ç›´æ’­ç«¯çš„æ’ä»¶å¼€å‘å¼€æ”¾å¹³å°

[[å“”å“©å“”å“©ç›´æ’­å¼€æ”¾å¹³å°](https://open-live.bilibili.com/)](https://open-live.bilibili.com/)

å¼€å‘è€…å¯ä»¥

1. ç”³è¯·å¼€å‘å¯†é’¥
2. å¼€å‘äº’åŠ¨åº”ç”¨
3. ä¸Šæ¶Bç«™çš„å•†åŸ

[[å“”å“©å“”å“©é¥­è´©](https://play-live.bilibili.com/)](https://play-live.bilibili.com/)

---

æœ‰äº†å¯†é’¥ä¹‹å

### è·å–ç›´æ’­é—´å¼¹å¹•æ•°æ®

![image](https://user-images.githubusercontent.com/9689442/221816031-b4c5f4fc-025a-44fb-94e7-42bacdd012da.png)

Bç«™ç»™å¼€å‘è¿™æä¾›äº†è·å–ç›´æ’­é—´æ•°æ®çš„æµç¨‹å’Œdemoä»£ç ã€‚

```python 

import asyncio
import json
import websockets
import requests
import time
import hashlib
import hmac
import random
from hashlib import sha256
import proto

class BiliClient:
    def __init__(self, roomId, key, secret, host = 'live-open.biliapi.com'):
        self.roomId = roomId
        self.key = key
        self.secret = secret
        self.host = host
        pass
    
    # äº‹ä»¶å¾ªç¯
    def run(self):
        loop = asyncio.get_event_loop()
        websocket = loop.run_until_complete(self.connect())
        tasks = [
            asyncio.ensure_future(self.recvLoop(websocket)),
            asyncio.ensure_future(self.heartBeat(websocket)), 
        ]
        loop.run_until_complete(asyncio.gather(*tasks))

    # httpçš„ç­¾å
    def sign(self, params):
        key = self.key
        secret = self.secret
        md5 = hashlib.md5()
        md5.update(params.encode())
        ts = time.time()
        nonce = random.randint(1,100000)+time.time()
        md5data = md5.hexdigest()
        headerMap = {
        "x-bili-timestamp": str(int(ts)),
        "x-bili-signature-method": "HMAC-SHA256",
        "x-bili-signature-nonce": str(nonce),
        "x-bili-accesskeyid": key,
        "x-bili-signature-version": "1.0",
        "x-bili-content-md5": md5data,
        }

        headerList = sorted(headerMap)
        headerStr = ''

        for key in headerList:
            headerStr = headerStr+ key+":"+str(headerMap[key])+"\n"
        headerStr = headerStr.rstrip("\n")

        appsecret = secret.encode() 
        data = headerStr.encode()
        signature = hmac.new(appsecret, data, digestmod=sha256).hexdigest()
        headerMap["Authorization"] = signature
        headerMap["Content-Type"] = "application/json"
        headerMap["Accept"] = "application/json"
        return headerMap

    # è·å–é•¿é“¾ä¿¡æ¯
    def websocketInfoReq(self, postUrl, params):
        headerMap = self.sign(params)
        r = requests.post(url=postUrl, headers=headerMap, data=params, verify=False)
        data = json.loads(r.content)
        print(data)
        return "ws://" + data['data']['host'][0]+":"+str(data['data']['ws_port'][0])+"/sub", data['data']['auth_body']

    # é•¿é“¾çš„authåŒ…
    async def auth(self, websocket, authBody):
        req = proto.Proto()
        req.body = authBody
        req.op = 7
        await websocket.send(req.pack())
        buf = await websocket.recv()
        resp = proto.Proto()
        resp.unpack(buf)
        respBody = json.loads(resp.body)
        if respBody["code"] != 0:
            print("auth å¤±è´¥")
        else:
            print("auth æˆåŠŸ")

    # é•¿é“¾çš„å¿ƒè·³åŒ…
    async def heartBeat(self, websocket):
        while True:
            await asyncio.ensure_future(asyncio.sleep(20))
            req = proto.Proto()
            req.op = 2
            await websocket.send(req.pack())
            print("[BiliClient] send heartBeat success")

    # é•¿é“¾çš„æ¥å—å¾ªç¯
    async def recvLoop(self, websocket):
        print("[BiliClient] run recv...")
        while True:
            recvBuf = await websocket.recv()
            resp = proto.Proto()
            resp.unpack(recvBuf)

    async def connect(self):
        postUrl = "https://%s/v1/common/websocketInfo"%self.host
        params = '{"room_id":%s}'%self.roomId
        addr, authBody = self.websocketInfoReq(postUrl, params)
        print(addr, authBody)
        websocket = await websockets.connect(addr)
        await self.auth(websocket, authBody)
        return websocket

if __name__=='__main__':
    try:
        cli = BiliClient(
            roomId = 23105976,
            key = "",
            secret = "",
            host = "live-open.biliapi.com")
        cli.run()
    except Exception as e:
        print("err", e)
```

å‚è€ƒè¿™ä¸ªæµç¨‹é‚£ä¹ˆäº’åŠ¨å¼¹å¹•çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ï¼š

1. è·å–wsåœ°å€ç«¯å£
2. å»ºç«‹wsé“¾æ¥
3. æ”¶å‘æ•°æ®
4. è§£æå‡ºå¼¹å¹•
5. æ‰§è¡Œæ¸¸æˆæŒ‡ä»¤/æ“ä½œ

---

æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ•ˆæœ

![image](https://user-images.githubusercontent.com/9689442/221816900-c00ef2a9-4bd9-4342-a9a9-f0d43ce993a2.png)

è¿™é‡Œæ¼”ç¤ºçš„æ˜¯å¼€æºé¡¹ç›®https://github.com/xfgryujk/blivechatçš„æœ¬åœ°pythonæœåŠ¡å™¨ï¼Œè¿™é‡Œå°±æ˜¯å®ç°äº†ä¸Šè¿°æµç¨‹ï¼ˆmockç‰ˆæœ¬ï¼‰

å¦‚æœæˆ‘ä»¬æŠŠroom IDæ¢æˆBç«™çº¿ä¸Šæ­£åœ¨å¼€æ’­çš„ç›´æ’­é—´IDï¼ŒåŒæ ·å¯ä»¥æŠ“åˆ°å¼¹å¹•ä¿¡æ¯ã€‚

å¥½ï¼Œå¼¹å¹•æˆ‘ä»¬å·²ç»æåˆ°äº†ï¼Œä¸‹ä¸€æ­¥ï¼Œé€‰æ‹©æ¸¸æˆ















## æ¸¸æˆ

è¿™é‡Œä¸ºäº†å¯¹æ¯”å‡ºæ•ˆæœï¼Œæˆ‘é€‰æ‹©äº†ä¸¤ç±»æ¸¸æˆï¼Œ å®æ—¶æ“ä½œç±» å’Œéå®æ—¶è§£è°œç±»ï¼Œä»£è¡¨ä½œ

- çº¢ç™½æœºï¼š[https://www.playfc.cn/](https://www.playfc.cn/)
    - æ¿€é¾Ÿå¿«æ‰“
    - è¶…çº§ç›ä¸½
- æ‰«é›·:[https://zhongyangxun.github.io/mine-sweeper/build/](https://zhongyangxun.github.io/mine-sweeper/build/)

---

### ç½‘é¡µç‰ˆçº¢ç™½æœºæ¸¸æˆ

ç½‘é¡µç‰ˆçº¢ç™½æœºæ¸¸æˆçš„åŸºæœ¬åŸç†

- JavaScript NES æ¨¡æ‹Ÿå™¨
- åŠ è½½ .nes æ–‡ä»¶
- æ³¨å†Œäº‹ä»¶ç›‘å¬
- å¾ªç¯frameTicker
    - ä½¿ç”¨canvasæ¸²æŸ“æ¯ä¸€å¸§
    - audioContextæ’­æ”¾éŸ³é¢‘é‡‡æ ·

---

æˆ‘ä»¬ä»¥æ¨¡æ‹Ÿå™¨https://github.com/bfirsh/jsnes ä¸ºä¾‹

æ ¸å¿ƒä½¿ç”¨ä»£ç ï¼š

```javascript
// å®ä¾‹åŒ–NESæ¨¡æ‹Ÿå™¨
this.nes = new NES({
      onFrame: this.screen.setBuffer,  // canvas
      onStatusUpdate: console.log,
      onAudioSample: this.speakers.writeSample, // éŸ³é¢‘
      sampleRate: this.speakers.getSampleRate()
    });

// äº‹ä»¶
this.gamepadController = new GamepadController({
      onButtonDown: this.nes.buttonDown,
      onButtonUp: this.nes.buttonUp
    });

this.keyboardController = new KeyboardController({
      onButtonDown: this.gamepadController.disableIfGamepadEnabled(
        this.nes.buttonDown
      ),
      onButtonUp: this.gamepadController.disableIfGamepadEnabled(
        this.nes.buttonUp
      )
    });

    // Load keys from localStorage (if they exist)
this.keyboardController.loadKeys();
document.addEventListener("keydown", this.keyboardController.handleKeyDown);
document.addEventListener("keyup", this.keyboardController.handleKeyUp);
document.addEventListener(
  "keypress",
  this.keyboardController.handleKeyPress
);

// åŠ è½½.nesï¼šROM
this.nes.loadROM(this.props.romData);
```

å…¶Web UI

![image](https://user-images.githubusercontent.com/9689442/221817388-4bb2757b-bc64-412e-a102-af516f0f0fee.png)


å¥½æˆ‘ä»¬ç›®å‰è‡³å°‘è·‘èµ·æ¥äº†ä¸€ä¸ªæ¸¸æˆäº†ï¼Œä¸‹ä¸€æ­¥

---

## å¦‚ä½•æŠŠæ¸¸æˆè·Ÿå¼¹å¹•è¿æ¥èµ·æ¥

ä¸€ä¸ªæ€è·¯ï¼šè§£æå¼¹å¹•æ‰§è¡Œæ¸¸æˆæŒ‡ä»¤

çº¢ç™½æœºæ¸¸æˆçš„æ¸¸æˆå†…åªæœ‰6ä¸ªæ§åˆ¶é”®

- up
- down
- left
- right
- A
- B

æ¸¸æˆå¤–å½“ç„¶è¿˜æœ‰start\pauseç­‰ï¼ˆæš‚æ—¶å…ˆä¸ç®¡

åœ¨jsçš„NES æ¨¡æ‹Ÿå™¨ä¸­ï¼Œè¿™äº›æ§åˆ¶é”®è¢«æ˜ å°„æˆä¸ºäº†é”®ç›˜çš„çš„æŒ‰é”®

![image](https://user-images.githubusercontent.com/9689442/221817478-58daf078-a031-4d80-b054-6feb39e85e26.png)

æˆ‘ä»¬è¦åšçš„å°±æ˜¯

- æ”¶åˆ°ç”¨æˆ·â€™wasdâ€™å¼¹å¹•
- è§£æå‡ºæ¥æ¯ä¸ªå­—ç¬¦
- æ¨¡æ‹Ÿè§¦å‘æµè§ˆå™¨çš„é”®ç›˜äº‹ä»¶
- æ§åˆ¶æ¸¸æˆ

---

### é‡åˆ°äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š

ä¸ºäº†æ–¹ä¾¿æ’æ‹”æ¸¸æˆï¼Œæˆ‘æŠŠæ¸¸æˆåŠ è½½åœ¨iframeä¸­ï¼Œé‡åˆ°äº†iframeè·¨åŸŸé—®é¢˜ï¼Œæ— æ³•è·å–iframeçš„å†…å®¹çª—å£å¹¶æ´¾å‘é”®ç›˜äº‹ä»¶ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆéå¸¸å¸¸è§å°±æ˜¯ä½¿ç”¨postMessage

åœ¨å¼¹å¹•è®¢é˜…é¡µï¼š

```javascript
import KEY_MAP from '../keyboard'
/**
 * å¿è€…ç¥é¾Ÿ4ç­‰NESæ¸¸æˆ
 */

const delay = sec => new Promise(resolve => setTimeout(resolve, sec))

export default class TurtleTrigger {
  constructor() {
    this.reg = /([A-Za-z0-9])/g
		// iframe
    this.dom = document.getElementById('iframeContain').contentWindow
    this.processing = false
  }

 // å‘é€æ¨¡æ‹Ÿé”®ç›˜äº‹ä»¶ç»™iframe
  _run = async key => {
    const evtOpt = KEY_MAP[key.toUpperCase()]
    this.dom.postMessage({ key: 'keydown', opt: evtOpt }, "*")
    return new Promise(resolve => {
      setTimeout(() => {
        this.dom.postMessage({ key: 'keyup', opt: evtOpt }, "*")
        resolve()
      }, 100)
    })
  }

  // å¼¹å¹•å¤„ç†å‡½æ•° 
  process = async danmu => {
    if (this.processing) {
      console.log('trigger proccessing')
      return
    }
    this.processing = true

  // æ­£åˆ™æŠŠå­—æ¯æå–å‡ºæ¥ 
    const matched = danmu.match(this.reg)
    console.log('matched', matched)
    if (!matched) {
      this.processing = false
      return false
    }
    // console.log('run matched', matched)
	
	// é€ä¸€æ‰§è¡Œ
    for (const value of matched) {
      await this._run(value)
      await delay(30)
    }
    this.processing = false
  }
}

```

åœ¨NESæ¸¸æˆé¡µé¢

```javascript
componentDidMount() {
    window.addEventListener('message', e => {
      console.log('msg=====',e.data)
      const { key ,opt} = e.data
      const evt = new KeyboardEvent(key, opt)
      document.dispatchEvent(evt)
    })
  }

```

---

### è¶…çº§ç›ä¸½

è¿™ä¸ªæ¸¸æˆé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¶…çº§ç›ä¸½ä¸­ï¼Œé•¿æŒ‰å’ŒçŸ­æŒ‰äº‹æœ‰ä¸åŒæ•ˆæœçš„

- çŸ­æŒ‰jumpï¼Œè·³å¾—çŸ®
- é•¿æŒ‰jumpï¼šè·³å¾—é«˜
- çŸ­æŒ‰æ–¹å‘é”®ï¼šçŸ­æš‚æ‹¥æœ‰ä¸€ä¸‹ä¸‹åŠ é€Ÿåº¦
- é•¿æŒ‰æ–¹å‘é”®ï¼šä¸€ç›´åŠ é€Ÿåˆ°æœ€é«˜

è€Œæ¸¸æˆä¸­å…³å¡è¢«è®¾è®¡å¾—æ˜¯å¿…é¡»é•¿æŒ‰æ‰èƒ½è¿‡å»çš„ï¼Œå› æ­¤è¿™é‡Œå¤„ç†å¼¹å¹•åˆ°æ—¶å€™ï¼Œå¾—å®ç°é•¿æŒ‰æ•ˆæœ

![image](https://user-images.githubusercontent.com/9689442/221817994-be48481e-2720-454d-a01f-2538df950da7.png)

æ€è·¯ï¼š

åˆå¹¶ç›¸åŒkeyï¼Œå»¶é•¿æŒ‰å‹æ—¶é—´

```javascript

// å‘é€æ¨¡æ‹Ÿé”®ç›˜äº‹ä»¶ç»™iframe
_run = async(key, duration = 1) => {
    const evtOpt = KEY_MAP[key.toUpperCase()]
    this.dom.postMessage({ key: 'keydown', opt: evtOpt }, "*")
    return new Promise(resolve => {
      setTimeout(() => {
        this.dom.postMessage({ key: 'keyup', opt: evtOpt }, "*")
        resolve()
			// å¯è°ƒèŠ‚æŒ‰å‹æ—¶é•¿
      }, duration * 100)
    })
  }

// åˆå¹¶ç›¸åŒæŒ‰é”®
  sumSame(chars) {
    const bucket = []
    let temp = {
      key: chars[0],
      count: 1
    }
    let i = 1
    while (i <= chars.length - 1) {
      if (temp.key === chars[i]) {
        temp.count++
      } else {
        bucket.push(temp)
        temp = {
          key: chars[i],
          count: 1
        }
      }
      i++
    }
    bucket.push(temp)
    console.log(bucket)
    return bucket
  }

process = async danmu => {
    // ...
    if (this.mergeSameKey) {
      const sum = this.sumSame(matched)
      for (const value of sum) {
        console.log(value)
        await this._run(value.key, value.count)
        await delay(30)
      }
    }
		// ...
  }

```


---

## æ‰«é›·

æ¨¡å¼æ˜¯ç±»ä¼¼çš„

- wsè®¢é˜…
- å¼¹å¹•æå–
- å‘æ¶ˆæ¯ç»™æ¸¸æˆçª—å£

ä¸åŒçš„ç‚¹åœ¨äº

![image](https://user-images.githubusercontent.com/9689442/221818330-73cd5c23-2ac4-4ed1-a910-01d10463cbf4.png)

æ‰«é›·çš„æ“ä½œæ–¹å¼ï¼š

- å·¦é”®ç‚¹å‡»åæ ‡ï¼šç¿»å¼€
- å³é”®ç‚¹å‡»æ ¼å­ï¼šæ’æ——

è¿™é‡Œå¦‚æœè½¬åŒ–ä¸ºå¼¹å¹•æ“ä½œæˆ‘ä»¬éœ€è¦æå–ä¸‰ä¸ªæ•°æ®

- æ“ä½œç±»å‹ï¼š left   or  right
- xåæ ‡
- yåæ ‡

é¦–å…ˆè®¾å®šå¼¹å¹•æ ¼å¼ä¸º4éƒ¨åˆ†ï¼Œ

- é¦–å­—ç¬¦Læˆ–è€…Rï¼Œè¡¨ç¤ºæ“ä½œç±»å‹
- æ•°å­—è¡¨ç¤ºxåæ ‡
- ç©ºæ ¼ï¼Œç”¨æ¥åˆ†å‰²ä¸¤ä¸ªæ•°å­—
- æ•°å­—è¡¨ç¤ºyåæ ‡

```
L0 0
R0 1

```

é‚£ä¹ˆæ•´ä½“çš„ä»£ç æµç¨‹å°±å¾ˆæ¸…æ™°äº†

---

### ä»£ç 

å¼¹å¹•è®¢é˜…å™¨

```javascript

/**
 * æ‰«é›·
 */

export default class SweeperTrigger {
  constructor(props) {
    this.reg = /^([lLRr])([0-9]+)\s([0-9]+)/
    this.dom = document.getElementById('iframeContain').contentWindow
    this.processing = false
    this.mergeSameKey = (props && props.mergeSameKey) || false
  }

  _run = async(key, x, y) => {
    console.log('_run', key, x, y)
    this.dom.postMessage({ key: key, opt: [x, y] }, "*")
  }

  process = async danmu => {
    if (this.processing) {
      console.log('trigger proccessing')
      return
    }
    this.processing = true

    const matched = this.reg.exec(danmu)
    console.log('matched', danmu, matched)
    // éæ³•è¿‡æ»¤
    if (!matched
      || matched.length !== 4
      || !['L', 'l', 'R', 'r'].includes(matched[1])
      || isNaN(parseInt(matched[2]))
      || isNaN(parseInt(matched[3]))) {
      console.log('éæ³•æŒ‡ä»¤')
      this.processing = false
      return false
    }

    await this._run(matched[1].toUpperCase(), parseInt(matched[2]), parseInt(matched[3]))
  
    this.processing = false
  }
}
```

æ¸¸æˆé¡µ

```javascript


componentDidMount() {
    window.addEventListener('message', (e) => {
      const { key, opt } = e.data
      if (!['L', 'R'].includes(key)) return
      console.log('msg=====', e.data)
      // è¾¹ç•Œæ£€æµ‹
      if (opt[0] < 0 || opt[0] > this.props.rowNum || opt[1] < 0 || opt[1] > this.props.rowNum) {
        return
      }
      // å·¦é”®å³é”®
      if (key === 'L') {
        this.handleSquareClick(opt[1], opt[0])
      } else {
        this.handleSquareContextMenu(opt[1], opt[0])
      }
    })
  }
```

---

## æ€»ç»“&å±•æœ›

webçš„äº’åŠ¨æ¸¸æˆå¯ä»¥åˆ†ä¸ºä¸‰å±‚ç»“æ„

- è®¢é˜…å±‚ï¼šå¤„ç†wsç­‰é“¾æ¥
- Trigger å±‚ï¼š æ ¹æ®æ¯ä¸ªæ¸¸æˆè®¾å®šçš„è§„åˆ™æ¥å¤„ç†å¼¹å¹•è½¬åŒ–ä¸ºæ¸¸æˆæŒ‡ä»¤
- æ¸¸æˆå±‚ï¼šæ¥å—æŒ‡ä»¤ï¼Œæ‰§è¡Œæ“ä½œï¼Œæ¸²æŸ“æ¸¸æˆ

æœªæ¥å‘å±•ä¸­ï¼Œå¯ä»¥æ¢ç´¢çš„å‡ ä¸ªæ–¹å‘

- æŠ½ç¦»ä¸“é—¨çš„Triggerç¼–è¾‘å™¨ï¼Œæ”¯æŒè‡ªå®šä¹‰è§„åˆ™
- å¼€å‘Native Triggerï¼Œæ¥å…¥å•æœºæ¸¸æˆå°è¯•
- é’ˆå¯¹ç›´æ’­å¼¹å¹•åœºæ™¯ä¸“é—¨è®¾è®¡æ¸¸æˆï¼šæ—¢æœ‰çš„æ¸¸æˆæ— æ³•å¾ˆå¥½çš„é€‚é…å¼¹å¹•äº’åŠ¨é•¿æ±Ÿï¼Œå¯¼è‡´å¾ˆå¤šä½“éªŒæ˜¯æœ‰é—®é¢˜çš„
- äº’åŠ¨æ¸¸æˆçš„å¹³è¡¡æ€§è®¾è®¡
    - å¤šäººå‚ä¸æ„Ÿï¼Œè€Œä¸æ˜¯å¤´éƒ¨ç”¨æˆ·
    - é¿å…é‡‘é’±è‡³ä¸Šï¼Œä¿è¯ç›´æ’­é—´æµé‡




